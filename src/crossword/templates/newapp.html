<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossword Puzzle</title>
    <script src="{{ url_for('static', filename='lib/vue.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/axios.min.js') }}"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <div id="app">
        <div id="notmenu">
            <div class="clue-column" data-label="ACROSS">
                <ul id="across">
                    <li v-for="word in crossword" v-if="word.direction === 'across' && !completedWords.has(word.clue)">
                        <span @click="handle_clue_click($event,word)">[[ word.index ]]. [[ word.clue ]]</span>
                        <div class="state-container">
                            <span v-for="(char, index) in getCurrentAnswer(word)" 
                                  :key="index"
                                  class="state"
                                  :class="{
                                      'red': isChecking && char.toLowerCase() !== word.answer[index].toLowerCase() && char !== ' ',
                                      'green': isChecking && char.toLowerCase() === word.answer[index].toLowerCase() && char !== ' '
                                  }">[[char]]</span>
                        </div>
                    </li>
                </ul>
            </div>
            
            <div class="center-column">
                <div id="crossword-container">
                    <div class="grid" :style="{
                        'grid-template-rows': `repeat(${grid.length}, var(--cell-size))`
                    }">
                        <div class="grid-row" v-for="(row, rowIndex) in grid" :key="rowIndex" 
                             :style="{
                                 'grid-template-columns': `repeat(${row.length}, var(--cell-size))`
                             }">
                            <div v-for="(cell, cellIndex) in row" :key="cellIndex" 
                                 class="grid-cell"
                                 :class="{'black-cell': cell === null}">
                                <span class="clue-index" v-if="find_index(rowIndex, cellIndex)">[[find_index(rowIndex, cellIndex)]]</span>
                                <template v-if="cell !== null">
                                    <input ref="inputCells" 
                                           :ref="'input-' + rowIndex + '-' + cellIndex"
                                           type="text" 
                                           maxlength="1" 
                                           v-model="grid[rowIndex][cellIndex]"
                                           @keydown="handle_crossword_cell_keydown($event, rowIndex, cellIndex)"
                                           @contextmenu.prevent="handleCellRightClick(rowIndex, cellIndex)"
                                           :data-row="rowIndex" 
                                           :data-cell="cellIndex"
                                           :data-solution="find_solution(rowIndex,cellIndex)"
                                           :aria-label="'grid cell ' + rowIndex + '-' + cellIndex">
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="menu">
                    <button @click="check_all()" id="check-all">Check all</button>
                    <div class="weekday-buttons">
                        <button @click="handleWeekdayClick('monday')" id="monday">
                            Mon
                            <span class="cache-count" v-if="cachedCrosswordsCount.monday > 0">([[cachedCrosswordsCount.monday]])</span>
                        </button>
                        <button @click="handleWeekdayClick('tuesday')" id="tuesday">
                            Tue
                            <span class="cache-count" v-if="cachedCrosswordsCount.tuesday > 0">([[cachedCrosswordsCount.tuesday]])</span>
                        </button>
                        <button @click="handleWeekdayClick('wednesday')" id="wednesday">
                            Wed
                            <span class="cache-count" v-if="cachedCrosswordsCount.wednesday > 0">([[cachedCrosswordsCount.wednesday]])</span>
                        </button>
                        <button @click="handleWeekdayClick('thursday')" id="thursday">
                            Thu
                            <span class="cache-count" v-if="cachedCrosswordsCount.thursday > 0">([[cachedCrosswordsCount.thursday]])</span>
                        </button>
                        <button @click="handleWeekdayClick('friday')" id="friday">
                            Fri
                            <span class="cache-count" v-if="cachedCrosswordsCount.friday > 0">([[cachedCrosswordsCount.friday]])</span>
                        </button>
                    </div>
                    <div class="utility-buttons">
                        <button @click="markCurrentPuzzleComplete()" id="mark-complete">Mark as Complete</button>
                        <button @click="openRawDataModal()" id="view-raw-data">View Raw Data</button>
                    </div>
                    <button @click="openSolvedModal()" id="overview-button">Overview</button>
                    <div class="status-indicators">
                        <div class="offline-indicator" v-if="isOffline">Offline Mode</div>
                    </div>
                    <div class="theme-switch">
                        <label class="switch">
                            <input type="checkbox" v-model="isDarkMode" @change="toggle_night_mode">
                            <span class="slider"></span>
                            <span class="switch-label">Night Mode</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="clue-column" data-label="DOWN">
                <ul id="down">
                    <li v-for="word in crossword" :key="word" v-if="word.direction ==='down' && !completedWords.has(word.clue)">
                        <span @click="handle_clue_click($event,word)">[[ word.index ]]. [[ word.clue ]]</span>
                        <div class="state-container">
                            <span v-for="(char, index) in getCurrentAnswer(word)" 
                                  :key="index"
                                  class="state"
                                  :class="{
                                      'red': isChecking && char.toLowerCase() !== word.answer[index].toLowerCase() && char !== ' ',
                                      'green': isChecking && char.toLowerCase() === word.answer[index].toLowerCase() && char !== ' '
                                  }">[[char]]</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Solved Puzzles Modal -->
        <div v-if="showSolvedModal" class="modal-overlay" @click.self="closeSolvedModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Solved Puzzles Overview</h2>
                    <button @click="closeSolvedModal" class="modal-close-button">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Heatmap Section -->
                    <div class="heatmap-outer-container">
                        <template v-if="Object.keys(yearlyHeatmapData).length > 0">
                            <div v-for="(yearData, year) in yearlyHeatmapData" :key="year" class="yearly-heatmap-section">
                                <h4>[[ year ]] Activity</h4>
                                <div class="heatmap-months">
                                    <!-- Statically render 12 month names -->
                                    <div class="heatmap-month-label">Jan</div>
                                    <div class="heatmap-month-label">Feb</div>
                                    <div class="heatmap-month-label">Mar</div>
                                    <div class="heatmap-month-label">Apr</div>
                                    <div class="heatmap-month-label">May</div>
                                    <div class="heatmap-month-label">Jun</div>
                                    <div class="heatmap-month-label">Jul</div>
                                    <div class="heatmap-month-label">Aug</div>
                                    <div class="heatmap-month-label">Sep</div>
                                    <div class="heatmap-month-label">Oct</div>
                                    <div class="heatmap-month-label">Nov</div>
                                    <div class="heatmap-month-label">Dec</div>
                                </div>
                                <div class="heatmap-body">
                                    <div class="heatmap-day-labels">
                                        <div class="heatmap-day-label">Sun</div>
                                        <div class="heatmap-day-label">Mon</div>
                                        <div class="heatmap-day-label">Tue</div>
                                        <div class="heatmap-day-label">Wed</div>
                                        <div class="heatmap-day-label">Thu</div>
                                        <div class="heatmap-day-label">Fri</div>
                                        <div class="heatmap-day-label">Sat</div>
                                    </div>
                                    <div class="heatmap-grid">
                                        <!-- Render empty offset cells -->
                                        <div v-for="n in yearData.firstDayOffset" :key="'offset-' + n" class="heatmap-cell empty-offset"></div>
                                        <!-- Render actual day cells -->
                                        <div v-for="(day, index) in yearData.days" 
                                             :key="index" 
                                             class="heatmap-cell"
                                             :class="{ 'solved': day.isSolved }"
                                             :title="day.isSolved ? 
                                                        `Title: ${day.details.title || 'N/A'}\n Puzzle ID: ${day.details.id}\nPublished: ${day.details.formattedOriginalDate || day.details.id}\nAuthors: ${day.details.authors ? day.details.authors.join(', ') : 'N/A'}\nSolved: ${new Date(day.details.dateSolved).toLocaleDateString()} ${new Date(day.details.dateSolved).toLocaleTimeString()}` 
                                                        : day.dateString">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <template v-else>
                            <p>No activity to display in heatmap yet.</p>
                        </template>
                         <div class="heatmap-legend" v-if="Object.keys(yearlyHeatmapData).length > 0">
                            Less <div class="heatmap-cell legend-sample-unsolved"></div>
                            <div class="heatmap-cell legend-sample-solved"></div> More
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raw Data Modal -->
        <div v-if="showRawDataModal" class="modal-overlay" @click.self="closeRawDataModal">
            <div class="modal-content raw-data-modal-content">
                <div class="modal-header">
                    <h2>Raw Puzzle Data</h2>
                    <button @click="closeRawDataModal" class="modal-close-button">&times;</button>
                </div>
                <div class="modal-body">
                    <pre id="raw-data-display">[[ rawPuzzleDataString ]]</pre>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='main.js') }}" type="module"></script>
</body>

</html>